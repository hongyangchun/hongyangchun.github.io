<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Using VNC to Connect to a XenServer VM&#39;s Console</title>
      <link href="/2020/09/10/using-vnc-to-connect-to-a-xenserver-vm-s-console/"/>
      <url>/2020/09/10/using-vnc-to-connect-to-a-xenserver-vm-s-console/</url>
      
        <content type="html"><![CDATA[<h1 id="Using-VNC-to-Connect-to-a-XenServer-VM’s-Console"><a href="#Using-VNC-to-Connect-to-a-XenServer-VM’s-Console" class="headerlink" title="Using VNC to Connect to a XenServer VM’s Console"></a>Using VNC to Connect to a XenServer VM’s Console</h1><h1 id="Origianl-Post"><a href="#Origianl-Post" class="headerlink" title="Origianl Post"></a>Origianl Post</h1><p><a href="https://www.citrix.com/blogs/2011/02/18/using-vnc-to-connect-to-a-xenserver-vms-console/">https://www.citrix.com/blogs/2011/02/18/using-vnc-to-connect-to-a-xenserver-vms-console/</a></p><p>In order to present a virtual machine’s console in XenCenter, XenServer creates a VNC stream for each VM that is running on the server. The VNC session is bound to the localhost address of the server (127.0.0.1) and is therefore not directly accessible from external VNC clients. In this post I’ll discuss a quick and dirty way to connect directly to the VM’s console using a remote VNC client and an SSH tunnel. Since there is not a version of XenCenter that runs on Linux, this method allows you to connect to XenServer VM consoles from a Linux machine.</p><p>This post will assume that the user doesn’t have access to XenCenter, but does have root access to the XenServers in a resource pool. To create the SSH tunnel it will expect that you’re using OpenSSH. If not, you’ll need to look at your SSH utility’s documentation to determine how to create SSH sessions and tunnels. Some VNC clients have the ability to establish SSH tunnels on their own. I’ve found these implementations to be hit or miss, so for this post we’ll separate SSH and VNC utilities. Also, note that this post will exclusively use the XenServer CLI. If you want to access the VNC console via the XAPI, documentation is found at <a href="http://docs.vmd.citrix.com/XenServer/5.6.0fp1/1.0/en_gb/sdk.html#retrieving_vnc_consoles_with_api">here</a>.</p><p>First, you’ll need to find the domain ID of the VM you’re interested in and the XenServer host that it’s running on. To do this you’ll need to SSH to one of the hosts in the resource pool and execute the following xe command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jeckle ~]<span class="comment"># xe vm-list params=dom-id,resident-on name-label=&lt;name of VM&gt;</span></span><br><span class="line">resident-on ( RO) : 06970b38-8b11-4228-bfc5-198405530e10 dom-id ( RO): 2</span><br></pre></td></tr></table></figure><p>Next, you’ll need to identify which server is running the VM from the uuid above:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jeckle ~]<span class="comment"># xe host-list uuid=06970b38-8b11-4228-bfc5-198405530e10</span></span><br><span class="line">uuid ( RO) : 06970b38-8b11-4228-bfc5-198405530e10 name-label ( RW): jeckle name-description ( RW): Default install of XenServer</span><br></pre></td></tr></table></figure><p>If you need to determine the IP address of the host that’s running the VM you can issue the following command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jeckle ~]<span class="comment"># xe pif-list management=true params=IP host-uuid=06970b38-8b11-4228-bfc5-198405530e10</span></span><br><span class="line">IP ( RO) : 192.168.10.52</span><br></pre></td></tr></table></figure><p>If necessary, establish an SSH session to the host that is running the VM you want to connect to.</p><p>Next, we’ll need to identify the port that XenServer is using to present the VM console’s VNC stream. In the code below, replace the 1 with the domain id you found in the previous step.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jeckle ~]<span class="comment"># xenstore-read /local/domain/1/console/vnc-port</span></span><br><span class="line">5902</span><br></pre></td></tr></table></figure><p>This tells you that you want to connect to the VM on port 5902.</p><p>Now that we know the port we want to connect to, we need to create an SSH tunnel to the XenServer and then connect the VNC client through the tunnel. An SSH tunnel basically says, any connection that is made to a selected port on the local machine will be forwarded through the SSH tunnel to an identified port that is accessible from the remote host you SSH to. To create the tunnel issue the following command in a local shell:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L &lt;<span class="built_in">local</span> port&gt;:localhost:&lt;VM console port&gt; &lt;username&gt;@&lt;xenserver host&gt;</span><br></pre></td></tr></table></figure><ul><li>local port: any unused port on the client host that you want to proxy through (should be greater than 1024)</li><li>VM console port: the port on the XenServer host that the VM console is listening on</li><li>username: the user account on the XenServer host that the VM is running on</li><li>xenserver host: the host your VM is running on</li></ul><p>Here’s an example:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 5903:localhost:5903 root@192.168.10.52</span><br></pre></td></tr></table></figure><p>This command says to send any traffic that is sent to local port 5903 on the client, through ssh to the host 192.168.10.52 and then redirect it to localhost:5903.</p><p>Once this is established, you can connect a VNC client to localhost:5903 and you’ll be connected to the VM’s console.</p><h1 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h1><p>I wrote a simple bash script to perform the above procedure automatically.</p><p>You can run it like this: ./getvncaccess</p><p>Create a file named “ getvncaccess”Make it executable: chmod +x getvncaccessPaste the following content into it:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> -ne 1 ]]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; You need to provide a vm name.&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">vmname=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">xe vm-list params=name-label name-label=<span class="variable">$&#123;vmname&#125;</span> | grep <span class="string">&quot; name-label.*: <span class="variable">$&#123;vmname&#125;</span>$&quot;</span> &gt; /dev/null</span><br><span class="line">exit_status=$?</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$exit_status</span> -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; <span class="variable">$&#123;vmname&#125;</span> is not a valid vm.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; Here is a list of available vms:&quot;</span></span><br><span class="line">xe vm-list params=name-label | grep -v <span class="string">&quot; Control domain&quot;</span> | cut -d: -f 2 | sed -e s/ *$//g -e /^$/d</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">resident_uuid=$(xe vm-list params=resident-on name-label=<span class="variable">$&#123;vmname&#125;</span> --minimal)</span><br><span class="line">domid=$(xe vm-list params=dom-id name-label=<span class="variable">$&#123;vmname&#125;</span> --minimal)</span><br><span class="line">vncport=$(xenstore-read /<span class="built_in">local</span>/domain/<span class="variable">$&#123;domid&#125;</span>/console/vnc-port)</span><br><span class="line"></span><br><span class="line">resident_ip=$(xe pif-list management=<span class="literal">true</span> params=IP host-uuid=<span class="variable">$&#123;resident_uuid&#125;</span> --minimal)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; Resident IP: <span class="variable">$&#123;resident_ip&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; VNC Port: <span class="variable">$&#123;vncport&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; &quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; Run the following command from your local PC to connect to the server using ssh and connect with a VNC client to localhost:<span class="variable">$&#123;vncport&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ssh -L <span class="variable">$&#123;vncport&#125;</span>:localhost:<span class="variable">$&#123;vncport&#125;</span> root@<span class="variable">$&#123;resident_ip&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><h1 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h1><h2 id="on-xenserver"><a href="#on-xenserver" class="headerlink" title="on xenserver"></a>on xenserver</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># xl list</span></span><br><span class="line">xl: /lib64/libnl-3.so.200: no version information available (required by /lib64/libxenlight.so.4.7)</span><br><span class="line">xl: /lib64/libnl-route-3.so.200: no version information available (required by /lib64/libxenlight.so.4.7)</span><br><span class="line">Name                                        ID   Mem VCPUs      State   Time(s)</span><br><span class="line">Domain-0                                     0   752     4     r-----  3134895.3</span><br><span class="line">win7-1                                      19  4099     4     -b----   20033.3</span><br><span class="line">win7-2                                      20  4099     4     -b----   19639.0</span><br><span class="line">win7-3                                      21  4099     4     -b----   19967.4</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br><span class="line">[root@localhost ~]<span class="comment"># xenstore-read /local/domain/19/console/vnc-port</span></span><br><span class="line">5903</span><br><span class="line">[root@localhost ~]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="on-local-PC"><a href="#on-local-PC" class="headerlink" title="on local PC"></a>on local PC</h2><ol><li>create ssh tunnel</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\HYC&gt; ssh -L 5903:localhost:5903 -p 6922 root@192.168.6.142</span><br></pre></td></tr></table></figure><ol start="2"><li>use vnc client (ultravnc viewer) to connect to localhost:5903</li></ol><p><img src="/2020/09/10/using-vnc-to-connect-to-a-xenserver-vm-s-console/Untitled.png" alt="UltraVNC Viewer"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Xen </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>third post</title>
      <link href="/2020/09/10/third-post/"/>
      <url>/2020/09/10/third-post/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>second post</title>
      <link href="/2020/09/10/second-post/"/>
      <url>/2020/09/10/second-post/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>first blog</title>
      <link href="/2020/09/10/first-blog/"/>
      <url>/2020/09/10/first-blog/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
